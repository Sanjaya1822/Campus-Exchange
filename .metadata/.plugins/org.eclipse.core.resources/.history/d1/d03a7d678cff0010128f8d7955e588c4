<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>

<%@ page import="java.sql.*" %>
<%@ page import="com.campusexchange.db.DBConnection" %>

<%
    // SESSION CHECK
    if (session == null || session.getAttribute("userEmail") == null) {
        response.sendRedirect("login.jsp");
        return;
    }

    String userEmail = (String) session.getAttribute("userEmail");
    String itemId = request.getParameter("id");

    if (itemId == null) {
        response.sendRedirect("buy.jsp");
        return;
    }
%>

<!DOCTYPE html>
<html>
<head>
    <title>Item Details | CampusExchange</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
    <a href="dashboard.jsp">Dashboard</a>
    <a href="buy.jsp">Buy</a>
    <a href="sell.jsp">Sell</a>
    <a href="rent.jsp">Rent</a>
    <a href="donate.jsp">Donate</a>
    <a href="logout">Logout</a>
</div>

<%
    Connection con = DBConnection.getConnection();

    PreparedStatement ps = con.prepareStatement(
        "SELECT * FROM items WHERE id = ?"
    );
    ps.setInt(1, Integer.parseInt(itemId));
    ResultSet rs = ps.executeQuery();

    if (rs.next()) {

        String sellerEmail = rs.getString("seller_email");
        String status = rs.getString("status");
%>

<!-- ITEM DETAILS -->
<div class="auth-container">

    <img src="uploads/<%= rs.getString("image") %>"
         style="width:100%; border-radius:12px; margin-bottom:20px;">

    <h2><%= rs.getString("title") %></h2>

    <p><%= rs.getString("description") %></p>

    <p class="price">
        ₹ <%= rs.getDouble("price") %>
    </p>

    <p class="contact">
        Seller: <strong><%= sellerEmail %></strong>
    </p>

    <!-- SELLER / BUYER LOGIC -->
    <%
        // SELLER VIEW
        if (userEmail.equals(sellerEmail)) {
    %>
        <p style="color:#7b1e3a; font-weight:bold; margin-top:15px;">
            You posted this item
        </p>

        <p style="margin-top:10px;">
            Status:
            <strong>
                <%= status %>
            </strong>
        </p>

    <%
        // BUYER VIEW – AVAILABLE
        } else if ("AVAILABLE".equals(status)) {
    %>
        <form action="interest" method="post">
            <input type="hidden" name="itemId" value="<%= rs.getInt("id") %>">
            <input type="submit" value="I'm Interested" class="interest-btn">
        </form>

    <%
        // BUYER VIEW – REQUESTED or SOLD
        } else {
    %>
        <p style="color:gray; margin-top:15px;">
            This item is no longer available
        </p>
    <%
        }
    %>

</div>

<%
    } else {
%>
    <p style="text-align:center;">Item not found</p>
<%
    }

    con.close();
%>

</body>
</html>
