<%@ page import="java.sql.*" %>
<%@ page import="com.campusexchange.db.DBConnection" %>

<%
    HttpSession sess = request.getSession(false);
    if (sess == null || sess.getAttribute("userEmail") == null) {
        response.sendRedirect("login.jsp");
        return;
    }

    String userEmail = (String) sess.getAttribute("userEmail");
    Connection con = DBConnection.getConnection();
%>

<!DOCTYPE html>
<html>
<head>
    <title>My Items</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="navbar">
    <a href="dashboard.jsp">Dashboard</a>
    <a href="sell.jsp">Sell</a>
    <a href="logout">Logout</a>
</div>

<div class="auth-container">
    <h2>My Items</h2>

<%
    PreparedStatement ps = con.prepareStatement(
        "SELECT * FROM items WHERE seller_email=? ORDER BY id DESC"
    );
    ps.setString(1, userEmail);
    ResultSet rs = ps.executeQuery();

    boolean hasItems = false;

    while (rs.next()) {
        hasItems = true;
%>

    <div class="item-card">
        <img src="uploads/<%= rs.getString("image") %>">
        <h3><%= rs.getString("title") %></h3>
        <p>â‚¹ <%= rs.getDouble("price") %></p>
        <p>Status: <b><%= rs.getString("status") %></b></p>

        <div class="btn-row">
            <form action="markSold" method="post">
                <input type="hidden" name="itemId" value="<%= rs.getInt("id") %>">
                <button class="btn-sold">Mark Sold</button>
            </form>

            <form action="deleteItem" method="post"
                  onsubmit="return confirm('Delete this item permanently?');">
                <input type="hidden" name="itemId" value="<%= rs.getInt("id") %>">
                <button class="btn-delete">Delete</button>
            </form>
        </div>
    </div>

<%
    }

    if (!hasItems) {
%>
    <p style="text-align:center;">No items posted yet</p>
<%
    }
    con.close();
%>

</div>
</body>
</html>
