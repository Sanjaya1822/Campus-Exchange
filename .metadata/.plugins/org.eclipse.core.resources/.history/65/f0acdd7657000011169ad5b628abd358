<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.sql.*" %>
<%@ page import="com.campusexchange.db.DBConnection" %>

<%
    // ===== SESSION CHECK =====
    HttpSession sess = request.getSession(false);
    if (sess == null || sess.getAttribute("userEmail") == null) {
        response.sendRedirect("login.jsp");
        return;
    }

    String userEmail = (String) sess.getAttribute("userEmail");
    String itemIdStr = request.getParameter("id");

    if (itemIdStr == null) {
        response.sendRedirect("buy.jsp");
        return;
    }

    int itemId = Integer.parseInt(itemIdStr);

    Connection con = DBConnection.getConnection();
%>

<!DOCTYPE html>
<html>
<head>
    <title>Item Details - CampusExchange</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
    <a href="dashboard.jsp">Dashboard</a>
    <a href="buy.jsp">Buy</a>
    <a href="sell.jsp">Sell</a>
    <a href="rent.jsp">Rent</a>
    <a href="donate.jsp">Donate</a>
    <a href="logout">Logout</a>
</div>

<%
    PreparedStatement ps = con.prepareStatement(
        "SELECT * FROM items WHERE id=?"
    );
    ps.setInt(1, itemId);
    ResultSet rs = ps.executeQuery();

    if (rs.next()) {

        String sellerEmail = rs.getString("seller_email");
%>

<div class="auth-container">

    <!-- IMAGE -->
    <img src="uploads/<%= rs.getString("image") %>"
         style="width:100%; max-height:300px; object-fit:cover; border-radius:10px;">

    <!-- DETAILS -->
    <h2><%= rs.getString("title") %></h2>
    <p><%= rs.getString("description") %></p>

    <p class="price">â‚¹ <%= rs.getDouble("price") %></p>
    <p>Seller: <strong><%= sellerEmail %></strong></p>

    <hr style="margin:20px 0;">

    <!-- STATUS MESSAGES -->
    <%
        if ("1".equals(request.getParameter("success"))) {
    %>
        <p style="color:green; text-align:center; font-weight:600;">
            âœ” Interest sent successfully
        </p>
    <%
        }
        if ("already".equals(request.getParameter("success"))) {
    %>
        <p style="color:#b35a00; text-align:center; font-weight:600;">
            âš  You already showed interest
        </p>
    <%
        }
    %>

    <!-- SELLER VIEW -->
    <%
        if (userEmail.equals(sellerEmail)) {
    %>

        <p style="color:#7b1e3a; font-weight:bold; text-align:center;">
            You posted this item
        </p>

        <h3 style="margin-top:20px;">Interested Students</h3>

        <%
            PreparedStatement psReq = con.prepareStatement(
                "SELECT buyer_email FROM item_requests WHERE item_id=?"
            );
            psReq.setInt(1, itemId);
            ResultSet rsReq = psReq.executeQuery();

            boolean found = false;
            while (rsReq.next()) {
                found = true;
        %>
                <p>ðŸ“§ <%= rsReq.getString("buyer_email") %></p>
        <%
            }
            <form action="markSold" method="post" style="margin-top:20px;">
            <input type="hidden" name="itemId" value="<%= itemId %>">
            <button type="submit" class="btn-primary"
                    style="background:#444;">
                Mark as Sold
            </button>
        </form>

            if (!found) {
        %>
                <p style="color:gray;">No interest yet</p>
        <%
            }
        %>

    <!-- BUYER VIEW -->
    <%
        } else {

            PreparedStatement chkPs = con.prepareStatement(
                "SELECT 1 FROM item_requests WHERE item_id=? AND buyer_email=?"
            );
            chkPs.setInt(1, itemId);
            chkPs.setString(2, userEmail);
            ResultSet chkRs = chkPs.executeQuery();

            if (chkRs.next()) {
    %>
                <button class="btn-primary"
                        style="opacity:0.6; cursor:not-allowed;" disabled>
                    Interest Sent âœ”
                </button>
    <%
            } else {
    %>
                <form action="interest" method="post" style="text-align:center;">
                    <input type="hidden" name="itemId" value="<%= itemId %>">
                    <button type="submit" class="btn-primary">
                        I'm Interested
                    </button>
                </form>
    <%
            }
        }
    %>

</div>

<%
    } else {
%>
    <p style="text-align:center;">Item not found</p>
<%
    }

    con.close();
%>

</body>
</html>
